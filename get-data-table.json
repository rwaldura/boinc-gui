#!/bin/sh
##############################################################################
#
# Output 
#
##############################################################################

readonly DATABASE=boinc_cluster_state.db
#readonly DATABASE=t/_test.db # for testing
#readonly DATABASE=prod.db

readonly NULL_ROW='{ "c": [] }'

readonly COLUMN_DEFS='
	{
		"id": "created",
		"label": "Day",
		"type": "datetime"
	},
	{
		"id": "app_name",
		"type": "string"
	},
	{
		"id": "app_user_friendly_name",
		"label": "BOINC App",
		"type": "string"
	},
	{
		"id": "project_name",
		"label": "Project",
		"type": "string"
	},
	{
		"id": "app_project_name",
		"label": "BOINC App (BOINC Project)",
		"type": "string"
	},
	{
		"id": "active_tasks",
		"label": "Tasks Running",
		"type": "number"
	}'

readonly SELECT_GROUPED="
    SELECT 
        date(created, 'localtime') AS day,
        app_name,
        app_user_friendly_name, 
		project_name,
		app_user_friendly_name || ' (' || project_name || ')' AS app_project_name,
        COUNT(DISTINCT result_name) AS active_tasks
    FROM 
        result1
    WHERE 
        datetime(created) >= datetime('now', '-7 day')
    GROUP BY 1, 2, 3, 4, 5"

readonly SELECT_JSON="
    SELECT 
        json_object('c', 
            json_array( 
                json_object('v', strftime('Date(%Y, %m, %d, 0, 0, 0, 0)', day)), 
                json_object('v', app_name),
                json_object('v', app_user_friendly_name),
                json_object('v', project_name),
                json_object('v', app_project_name),
                json_object('v', active_tasks)
                ))
    FROM ( $SELECT_GROUPED )"

##############################################################################
# main

rows=$( sqlite3 -list -noheader -newline "," "$DATABASE" "$SELECT_JSON" )

# output entire document
cat <<_JSON_ 
{
	"cols": [ $COLUMN_DEFS ],
	"rows": [ $rows $NULL_ROW ]
}
_JSON_

exit 0



