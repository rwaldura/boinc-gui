#!/bin/sh

#readonly DATABASE=boinc_cluster_state.db
#readonly DATABASE=t/_test.db # for testing
readonly DATABASE=prod.db

readonly NULL_ROW='{ "c": [] }'

readonly COLUMN_DEFS='
	{
		"id": "updated",
		"label": "Updated",
		"type": "datetime"
	},
	{
		"id": "app_name",
		"label": "BOINC App",
		"type": "string"
	},
	{
		"id": "count",
		"label": "Tasks Completed",
		"type": "number"
	}'

readonly SELECT_GROUP="
	SELECT 
		date(updated, 'localtime') AS updated, 
		app_user_friendly_name, 
		COUNT(*) AS n
	FROM 
		result
	WHERE 
		datetime(updated) > datetime('now', '-30 day')
	GROUP BY
		1, 2"

readonly SELECT_JSON="
	SELECT 
		json_object('c', 
			json_array( 
				json_object('v', strftime('Date(%Y, %m, %d, 0, 0, 0, 0)', updated)), 
				json_object('v', app_user_friendly_name),
				json_object('v', n)
				))
	FROM ( $SELECT_GROUP )"

##############################################################################
# main

rows=$( sqlite3 -list -noheader -newline "," "$DATABASE" "$SELECT_JSON" )

# output entire document
cat <<_JSON_ 
{
	"cols": [ $COLUMN_DEFS ],
	"rows": [ $rows $NULL_ROW ]
}
_JSON_

exit 0



