#!/bin/sh
#
# Get cluster state as one big XML document. 
# Issue a BOINC GUI RPC request "get_state" against each cluster
# node, and assemble the results into a XML document.
# See
# https://boinc.berkeley.edu/trac/wiki/GuiRpcProtocol#get_state
#
# The XML document produced references a stylesheet; this stylesheet
# is used to transform the document into HTML, client-side. 
#
# Depends on: netcat
#

readonly BOINC_GUI_RPC_PORT=31416
readonly ETX='\003' # control character used by BOINC GUI RPC

readonly cluster_nodes="bb37 bb34 bb43 bb30 bb55 bb47 bb10 bb15"
readonly other_nodes="beaglebone680 beaglebone230 beaglebone369"

nodes=$( shuf --echo $cluster_nodes $other_nodes ) # randomize nodes
date=$( date )

cat <<_XML_
<?xml version="1.0" encoding="UTF-8" ?>
<?xml-stylesheet href="gui.xsl" type="text/xsl" ?>

<boinc_cluster_state created="$date">
_XML_

for node in $nodes
do
	echo "<boinc_client hostname=\"$node\">"
	echo "<boinc_gui_rpc_request>\n<get_state/>\n</boinc_gui_rpc_request>$ETX" | 
		nc -q 1 $node $BOINC_GUI_RPC_PORT |
			tr $ETX '\n'
	echo "</boinc_client>"
done 

echo "</boinc_cluster_state>"

